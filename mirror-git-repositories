#!/bin/sh -ex
function repackRepo()
{
  git repack -a -d -f --max-pack-size=10g --depth=100 --window=250
  git pack-refs --all
}

kinit -R
MIRROR=/afs/.cern.ch/cms/git-cmssw-mirror
CERN_REPO=https://:@git.cern.ch/kerberos
cd $MIRROR/cmssw.git ; git config http.postBuffer 209715200 ; git remote update origin ; repackRepo ; git push --mirror $CERN_REPO/CMSSW.git
cd $MIRROR/cmsdist.git ; git config http.postBuffer 209715200 ; git remote update origin ; repackRepo ; git push --mirror $CERN_REPO/CMSDIST.git
cd $MIRROR/pkgtools.git ; git config http.postBuffer 209715200 ; git remote update origin ; repackRepo ; git push --mirror $CERN_REPO/PKGTOOLS.git
cd $MIRROR/cmssw-config.git ; git config http.postBuffer 209715200 ; git remote update origin ; repackRepo ; git push --mirror $CERN_REPO/CMSSW/config.git
cd $MIRROR/SCRAM.git ; git config http.postBuffer 209715200 ; git remote update origin ; repackRepo ; git push --mirror $CERN_REPO/SCRAM.git
cd $MIRROR/ib-scheduler.git ; git config http.postBuffer 209715200 ; git remote update origin ; repackRepo ; git push --mirror $CERN_REPO/ib-scheduler.git
/afs/cern.ch/cms/sdt/internal/requestHandler/requestGitMirrorSync.py

du -sh /afs/.cern.ch/cms/git-cmssw-mirror
