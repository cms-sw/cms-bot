#! /usr/bin/env python

from optparse import OptionParser
import subprocess
import re
import json
import pickle

#-----------------------------------------------------------------------------------
#---- Parser Options
#-----------------------------------------------------------------------------------
parser = OptionParser(usage="usage: %prog COMPARISON_PAIRS" 
                            "\n COMPARISON_PAIRS: a list separated by commas with the pairs of tags or "
			    "\n heads or branches that you want to compare, this pairs should be separated by .."
                            "\n For example:"
			    "\n CMSSW_7_1_0_pre2..CMSSW_7_0_X,CMSSW_6_2_7..CMSSW_6_2_X")

(options, args) = parser.parse_args()

#-----------------------------------------------------------------------------------
#---- Review of arguments
#-----------------------------------------------------------------------------------

if (len(args)==0):
  print 'not enough arguments\n'
  parser.print_help()
  exit()

requested_comparisons_param = args[0]

requested_comparisons = requested_comparisons_param.split(",")

#-----------------------------------------------------------------------------------
#---- Fuctions
#-----------------------------------------------------------------------------------


def get_pr_number(line_parts):
  number_and_name = line_parts[0].replace('"','')
  number = re.sub(' from .*', '', number_and_name)
  number = re.sub('Merge pull request #', '', number)
  return number

def get_pr_author_login(line_parts):
  number_and_name = line_parts[0].replace('"','')
  name = re.sub('^Merge .* from ', '', number_and_name)
  name = name.split('/')[0]
  return name

def get_pr_title(line_parts):
  title = line_parts[1].replace('"','').strip()
  return title

def get_info_pr(line):
  pull_request = {}
  line_parts = line.split(',')
  pull_request['number'] = get_pr_number(line_parts)
  pull_request['author_login'] = get_pr_author_login(line_parts)
  pull_request['title'] = get_pr_title(line_parts)
  pull_request['url'] = 'https://github.com/cms-sw/cmssw/pull/%d' % int(pull_request['number'])
  return pull_request

def get_tags_from_line(line, release_queue):
  if 'tags->' not in line:
    return []
  tags_str = line.split('tags->')[1]
  filter = release_queue[:-1]
  ## if the tags part is equal to ," there are no tags
  if tags_str != ',"':
    tags = tags_str.split(',',1)[1].strip().replace('(','').replace(')','').split(',')
    #I also have to remove the branch name
    tags = [t for t in tags if filter in t and t.strip().replace('"','') != release_queue]
    return [t.replace('"','').replace('tag:','').strip() for t in tags]
  else:
    return []


#-----------------------------------------------------------------------------------
#---- Fuctions -- Analize Git ouputs
#-----------------------------------------------------------------------------------


def get_results_one_relval_file(file):
  read_last_line_command = 'tail -n1 %s' %file

  p = subprocess.Popen(read_last_line_command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
  out,err = p.communicate()
  ret_code = p.returncode

  if ret_code != 0:
    print ret_code
    print 'Error:'
    print err
    exit(1)

  if '0 0 0 0 0 failed' in out:
    return True
  else:
    return False

def analyze_relvals_results(output,relvals_results,arch):
  for line in output.splitlines():
    m = re.search('CMSSW.*[0-9]/', line)
    rel_name = line[m.start():m.end()-1]
    result_arch = {}
    result_arch['arch'] = arch
    result_arch['file'] = line
    passed = get_results_one_relval_file(line)
    result_arch['passed'] = passed

    if rel_name not in relvals_results.keys():
      relvals_results[rel_name] = []

    relvals_results[rel_name].append(result_arch)
		
def get_tags(output,release_queue):
  tags = []
  for line in output.splitlines():
    tags += get_tags_from_line(line, release_queue)

  return tags

#-----------------------------------------------------------------------------------
#---- Fuctions -- Execute Magic commands
#-----------------------------------------------------------------------------------

def get_output_command(command_to_execute):
  print 'Executing:'
  print command_to_execute

  p = subprocess.Popen(command_to_execute, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
  out,err = p.communicate()
  ret_code = p.returncode

  if ret_code != 0 and out != '':
    print ret_code
    print 'Error:'
    print err
    exit(1)
  return out

def execute_magic_command_tags(start_tag,end_tag,release_queue):
  tags = []
  command_to_execute = magic_command_tags.replace('START_TAG',start_tag).replace('END_TAG',end_tag)
  out = get_output_command(command_to_execute)
  tags = get_tags(out,release_queue)
  tags.append(start_tag)
  tags = [t for t in reversed(tags)]
  return tags

def execute_command_compare_tags(start_tag,end_tag):
  command_to_execute = magic_command_prs.replace('START_TAG',start_tag).replace('END_TAG',end_tag)
  output = get_output_command(command_to_execute)
  print '------'
  comp = {}
  comp['compared_tags'] = '%s-->%s' % (start_tag,end_tag)
  prs = []
  for line in output.splitlines():
    pr = get_info_pr(line)
    prs.append(pr)
  comp['merged_prs'] = prs
  return comp

def compare_tags(tags):
  comparisons = []
  for i in range(len(tags)-1):
    comp = execute_command_compare_tags(tags[i],tags[i+1])
    comparisons.append(comp)
  return comparisons


def execute_magic_command_find_results_relvals(relvals_results):
  for arch in architectures:
    command_to_execute = magic_command_find_resutls_relvals.replace('ARCHITECTURE',arch)
    out = get_output_command(command_to_execute)
    analyze_relvals_results(out,relvals_results,arch)



def print_results(results):
  print "Results:"
  print
  print
  for rq in results:
    print
    print rq['release_name']
    print '/////////////////////////'
    for comp in rq['comparisons']:
      print comp['compared_tags']

      relvals_results = [res['arch']+':'+str(res['passed']) for res in comp['relvals'] ]
      print '\t' + str(relvals_results)

      merged_prs = [pr['number'] for pr in comp['merged_prs']]
      print '\t' + str(merged_prs)

def add_relvals_to_results(results, relvals_results):
  for rq in results:
    for comp in rq['comparisons']:
      rel_name = comp['compared_tags'].split('-->')[1]
      results = relvals_results.get(rel_name)
      comp['relvals'] = results if results else []


#-----------------------------------------------------------------------------------
#---- Start of execution
#-----------------------------------------------------------------------------------

magic_command_prs = 'GIT_DIR=/afs/cern.ch/cms/git-cmssw-mirror/cmssw.git git log --merges  --pretty=\'"%s", "%b", "tags->,%d"\' START_TAG..END_TAG | grep "Merge pull"'

magic_command_find_resutls_relvals = 'find /afs/cern.ch/cms/sw/ReleaseCandidates/ARCHITECTURE/www -name runall-report-step123-.log'

magic_command_tags = 'GIT_DIR=/afs/cern.ch/cms/git-cmssw-mirror/cmssw.git git log --merges  --pretty=\'"%s", "%b", "tags->,%d"\' START_TAG..END_TAG | grep -E "Merge [pull|remote]"'

architectures = ['slc5_amd64_gcc462','slc6_amd64_gcc472','slc5_amd64_gcc472','slc5_amd64_gcc481','slc6_amd64_gcc481']

print magic_command_prs

results = []

for comp in requested_comparisons:
  start_tag = comp.split("..")[0]
  end_tag = comp.split("..")[1]
  release_queue = start_tag
	
  # if is a SLHC or any special release, the split will happen with the fifth underscore _
  if 'SLHC' in release_queue or 'BOOSTIO' in release_queue or 'ROOT6' in release_queue or 'THREADED'in release_queue or 'GEANT10' in release_queue:
    release_queue = re.match(r'^((?:[^_]*_){%d}[^_]*)_(.*)' % (4), release_queue).groups()[0]
  else:
    release_queue = re.match(r'^((?:[^_]*_){%d}[^_]*)_(.*)' % (3), release_queue).groups()[0]

  print "I will analyze %s from %s to %s:" % (release_queue,start_tag,end_tag)

  release_queue_results = {}
	
  release_queue_results['release_name'] = release_queue

  tags = execute_magic_command_tags(start_tag,end_tag,release_queue)

  release_queue_results['comparisons'] = compare_tags(tags)

  results.append(release_queue_results)
	
  print 
  print "^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"

relvals_results = {}

execute_magic_command_find_results_relvals(relvals_results)

add_relvals_to_results(results, relvals_results)

print_results(results)

out_json = open("merged_prs_summary.json", "w")
json.dump(results,out_json,indent=4)
out_json.close()
